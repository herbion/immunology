<style>
.analysis {
	display: table;
	position: relative;
	width: 100%;
	margin: 0px 0px 5px 0px;
	background-color: #E1EEF4;
}

.analysisName {
	background-color: #2191C0;
    color: #FFFFFF;
    font-weight: bold;
    padding: 4px 10px;
    width: 300px;
    text-align: right;
    float: left;
}

.analysisNormsSelect {
	width: 250px;
}

.analysisDescription {
    color: #00557F;
    text-align: center;
    width: 60%;
    display: table-cell;
    vertical-align: middle;
}

.editButtonDiv {
	display: table;
    height: 25px;
    position: relative;
    width: 100%;
}

.treatmentTypeName {
	background-color: #2191C0;
	color: #FFFFFF;
	font-weight: bold;
	font-size: 13px;
	padding: 4px 10px;
	text-align: center;
}

#treatment-info ul {
	padding-left: 0px;
	list-style-type: none;
	margin-top: 2px;
}

.medicationName {
	width: 280px;
	background: #379CC6;
	color: #FFFFFF;
	font-weight: bold;
	padding: 2px 10px;
	text-align: right;
	margin-top: 5px;
	border-top-right-radius: 3px;
	border-bottom-right-radius: 3px;
	font-size: 13px;
}

.medicationDetailName {
	width: 250px;
	background: #4da7cc;
	color: #FFFFFF;
	font-weight: bold;
	padding: 2px 10px;
	text-align: right;
	float: left;
	margin-right: 110px;
}

.treatment-checkbox {
	margin: 2px 0px 0px 0px;
}

.insertion-select {
	margin: 0px 0px 0px 10px;
	font-family: 'Helvetica','Arial','Sans' !important;
    font-size: 12px !important;
}

#selectInsertionBlock {
	display: inline;
}

.treatments {
	padding: 5px 0px;
	border-bottom: 1px solid #2191C0;
}

#treatment-info label {
	font-weight: bold;
	float: none;
	width: none;
	color: #666;
	cursor: pointer;
	display: inline;
}

.treatment-multiplicity, .treatment-dose, .treatment-description {
	width: 100px;
	margin: 0px 20px 0px 5px;
	padding: 1px;
	height: 16px;
	overflow: hidden;
}

.treatment-multiplicity{
	width: 30px;	
}

#selectTherapyTypeBlock, #selectAllergenBlock {
	display: inline;
	margin: 0px 0px 0px 10px;
}

.therapy-type-select, .allergen-select {
	font-family: 'Helvetica','Arial','Sans' !important;
	font-size: 12px !important;
}

</style>

<script>
$(document).ready(function() {
	$("textarea").addClass("autogrow-short").autogrow();
	$("#treatment-info").accordion({ collapsible: true, active: false, header: "h3", autoHeight: false });
});

var saveTreatments = function () {
	var jsonObject = "";
	var surveyId = $("#hidden-survey-id").val();
	var medicineCardId = $("#hidden-med-card-id").val();
	var syndromeId = $("input[name='synd_radio']:checked").attr('value');

	var isEmpty = true;
	
	jsonObject = jsonObject + "{'surveyId':" + surveyId + ",";
	jsonObject = jsonObject + "'medicineCardId':" + medicineCardId + ",";
	jsonObject = jsonObject + "'syndromeId':" + syndromeId;
	
	$(".treatments").each(function() {
		$checkbox = $(this).find(".treatment-checkbox");
		$multiplicity = $(this).find(".treatment-multiplicity");
		$dose = $(this).find(".treatment-dose");
		$description = $(this).find(".treatment-description");
		$insertionType = $(this).find(".insertion-select option:selected"); 
		$therapyType = $(this).find(".therapy-type-select option:selected");
		$allegren = $(this).find(".allergen-select option:selected");
		var treatmentId = $checkbox.val();
		var insertionId = null;
		var therapy = null;
		var allegrenId = null;
		var multiplicity = null;
		var dose = null;
		var description = null;
		var checked = "false";
		if($checkbox.is(":checked")){
			if(isEmpty){
				jsonObject = jsonObject + ",'treatments':[";
			}
			isEmpty = false;
			checked = "true";
			if($description.val() != "" && $description.val() != undefined) {
				description = "'" + $description.val() + "'";
			}
			if($multiplicity.val() != "" && $multiplicity.val() != undefined) {
				multiplicity = "'" + $multiplicity.val() + "'"; 
			}
			if($dose.val() != "" && $dose.val() != undefined) {
				dose = "'" + $dose.val() + "'"; 
			}
			if($insertionType.val() != 0 && $insertionType.val() != "" && $insertionType.val() != undefined) {
				insertionId = "'" + $insertionType.val() + "'"; 
			}
			if($therapyType.val() != 0 && $therapyType.val() != "" && $therapyType.val() != undefined) {
				therapy = "'" + $therapyType.val() + "'"; 
			}
			if($allegren.val() != 0 && $allegren.val() != "" && $allegren.val() != undefined) {
				allegrenId = "'" + $allegren.val() + "'"; 
			}
			jsonObject = jsonObject + "{'id':" + treatmentId + ",";
			jsonObject = jsonObject + "'insertionId':" + insertionId + ",";
			jsonObject = jsonObject + "'allegrenId':" + allegrenId + ",";
			jsonObject = jsonObject + "'therapy':" + therapy + ",";
			jsonObject = jsonObject + "'isChecked':" + checked + ",";
			jsonObject = jsonObject + "'description':" + description + ",";
			jsonObject = jsonObject + "'dose':" + dose + ",";
			jsonObject = jsonObject + "'multiplicity':" + multiplicity + "},";
		}
	});
	if(!isEmpty){
		jsonObject = jsonObject.substring(0, jsonObject.length - 1);
		jsonObject = jsonObject + "]";
	}
	jsonObject = jsonObject + "}";
	console.log("jsonObject: " + jsonObject);

	$.ajax({
		type : "POST",
		url : "/surveyView/saveTreatments",
		data : jsonObject,
		dataType : "json",
		contentType : "application/json",
		success : function(id) {
			$("#hidden-survey-id").val(id);
			noty({
				text: "&{'treatments.save.success'}",
				layout: "topRight",
				type: "success"
				});
		},
		error : function(e) {
			noty({
				text: "&{'treatments.save.error'}",
				layout: "topRight",
				type: "error"
			});
		}
	});
}
</script>

<div id="treatment-info">
	#{if syndrome != null}
		#{list items: models.TreatmentType.find("bySyndrome", syndrome).fetch(), as:'treatmentType'}
			<!-- <div class="treatmentTypeName"></div> -->
			<h3 class="treatmentTypeName">${treatmentType.treatmentTypeName}</h3>
			<div>
	 			#{list items:models.Medication.find("byTreatmentType", treatmentType).fetch(), as:'medication'}
	    			<div class="medicationName">${medication.medicationName}</div>
	 				#{list items:models.MedicationDetail.find("byMedication", medication).fetch(), as:'medicationDetail'}
		    			<div class="treatments">
			    			<div class="medicationDetailName">${medicationDetail.medicationDetailName}</div>
							<div>
								<input class="treatment-checkbox" value="${medicationDetail.medicationDetailId}" type="checkbox">
				    			<div id="selectInsertionBlock">
				    				#{if medicationDetail.insertions != null && !medicationDetail.insertions.isEmpty()}
										#{select 'insertions', items:medicationDetail.insertions, valueProperty:'insertionId', labelProperty:'insertionName', value:0, class:'insertion-select'}
											#{option 0} &{'select.insertion'} #{/option}
										#{/select}
				    				#{/if}
								</div>
								<div id="selectTherapyTypeBlock">
									#{if treatmentType.hasTherapyType} 
										#{select 'therapy-type', class:'therapy-type-select'}
											#{option '0'}&{'select.therapy.type'}#{/option}
											#{option 'BASIC'}&{'therapy.type.basic'}#{/option}
											#{option 'SUPPORTING'}&{'therapy.type.supporting'}#{/option}
										#{/select}
									#{/if}				
								</div>
								<div id="selectAllergenBlock">
				    				#{if medicationDetail.allergens != null && !medicationDetail.allergens.isEmpty()}
										#{select 'allergens', items:medicationDetail.allergens, valueProperty:'allergenId', labelProperty:'allergenName', value:0, class:'allergen-select'}
											#{option 0} &{'select.allergen'} #{/option}
										#{/select}
				    				#{/if}
								</div>
							</div>
							<div style="margin: 6px 0px 4px 390px">
								<label>&{'treatment.description'}</label>
								<textarea class="treatment-description"></textarea>
								<label>&{'treatment.multiplicity'}</label>
								<textarea class="treatment-multiplicity"></textarea>
								<label>&{'treatment.dose'}</label>
								<textarea class="treatment-dose"></textarea>
							</div>
		    			</div>
		 	   		#{/list}
		    	#{/list}
	    	</div>
	 	#{/list}
	#{/if}
	<div class="editButtonDiv">
		<input type="submit" class="editButton" onclick="saveTreatments();" id="editAnalysesButton" value="&{'save'}">
	</div>
</div>